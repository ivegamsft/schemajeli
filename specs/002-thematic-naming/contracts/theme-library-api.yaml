openapi: 3.0.3
info:
  title: SchemaJeli Theme Library API
  description: |
    Browse, search, and preview built-in theme templates (US-2, US-4).
    The theme library is a read-only catalog of pre-populated themes
    that users can browse and use to create new thematic guides.

    **Performance targets:**
    - SC-002: Theme gallery loads in <1 second
    - SC-009: Search/filter returns results in <1 second
    - SC-011: 10 pre-populated themes with 400+ total elements
  version: 1.0.0
  contact:
    name: SchemaJeli Team

servers:
  - url: /api/v1
    description: API v1 base path

security:
  - bearerAuth: []

tags:
  - name: Theme Library
    description: Browse and search built-in theme templates

paths:
  /theme-library:
    get:
      operationId: listThemeLibrary
      summary: List built-in themes
      description: |
        Returns a paginated list of all built-in theme templates (US-2 scenario 4).
        Displays themes with name, icon, description, and element count.
        Supports filtering by category and sorting by popularity or name.

        **Performance**: SC-002 — must load <1 second for 10+ themes.
      tags: [Theme Library]
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
        - name: category
          in: query
          description: Filter by theme category (FR-010)
          schema:
            $ref: '#/components/schemas/ThemeCategory'
        - name: sortBy
          in: query
          description: Sort field
          schema:
            type: string
            enum: [name, popularityScore, elementCount, createdAt]
            default: popularityScore
        - name: sortOrder
          in: query
          description: Sort direction
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Paginated list of theme library items
          content:
            application/json:
              schema:
                type: object
                required: [data, meta]
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ThemeLibraryItem'
                  meta:
                    $ref: '#/components/schemas/PaginationMeta'
              example:
                data:
                  - id: "11111111-1111-1111-1111-111111111111"
                    name: "Harry Potter"
                    category: FICTION
                    description: "Characters, spells, and potions from the Wizarding World"
                    iconUrl: "/icons/harry-potter.svg"
                    elementCount: 52
                    popularityScore: 150
                    previewElements: ["dumbledore", "hermione", "hogwarts", "expelliarmus", "phoenix"]
                    createdAt: "2026-02-08T00:00:00.000Z"
                  - id: "22222222-2222-2222-2222-222222222222"
                    name: "Star Wars"
                    category: FICTION
                    description: "Planets, characters, and starships from a galaxy far, far away"
                    iconUrl: "/icons/star-wars.svg"
                    elementCount: 63
                    popularityScore: 130
                    previewElements: ["tatooine", "yoda", "lightsaber", "coruscant", "endor"]
                    createdAt: "2026-02-08T00:00:00.000Z"
                  - id: "33333333-3333-3333-3333-333333333333"
                    name: "Fruit"
                    category: NATURE
                    description: "Common and exotic fruit names for fresh naming conventions"
                    iconUrl: "/icons/fruit.svg"
                    elementCount: 32
                    popularityScore: 90
                    previewElements: ["apple", "mango", "kiwi", "strawberry", "pineapple"]
                    createdAt: "2026-02-08T00:00:00.000Z"
                meta:
                  total: 10
                  page: 1
                  perPage: 20
                  totalPages: 1
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /theme-library/search:
    get:
      operationId: searchThemeLibrary
      summary: Search themes by name or keyword
      description: |
        Searches theme library items by name, description, or keyword (FR-010, US-4 scenario 4).
        For example, searching "space" finds "Star Wars" and "Planets".

        **Performance**: SC-009 — search returns results in <1 second.
        SC-012 — search across all themes and user-created themes.
      tags: [Theme Library]
      security:
        - bearerAuth: []
      parameters:
        - name: q
          in: query
          required: true
          description: |
            Search query string. Searches across theme name, description,
            and preview elements (case-insensitive partial match).
          schema:
            type: string
            minLength: 1
            maxLength: 200
        - name: category
          in: query
          description: Optionally restrict search to a category
          schema:
            $ref: '#/components/schemas/ThemeCategory'
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PerPageParam'
      responses:
        '200':
          description: Search results with relevance ranking
          content:
            application/json:
              schema:
                type: object
                required: [data, meta]
                properties:
                  data:
                    type: array
                    items:
                      allOf:
                        - $ref: '#/components/schemas/ThemeLibraryItem'
                        - type: object
                          properties:
                            relevanceScore:
                              type: number
                              format: float
                              description: Search relevance score (0-1)
                  meta:
                    allOf:
                      - $ref: '#/components/schemas/PaginationMeta'
                      - type: object
                        properties:
                          query:
                            type: string
                            description: The search query used
              example:
                data:
                  - id: "22222222-2222-2222-2222-222222222222"
                    name: "Star Wars"
                    category: FICTION
                    description: "Planets, characters, and starships from a galaxy far, far away"
                    iconUrl: "/icons/star-wars.svg"
                    elementCount: 63
                    popularityScore: 130
                    previewElements: ["tatooine", "yoda", "lightsaber", "coruscant", "endor"]
                    createdAt: "2026-02-08T00:00:00.000Z"
                    relevanceScore: 0.95
                  - id: "55555555-5555-5555-5555-555555555555"
                    name: "Planets"
                    category: NATURE
                    description: "Celestial bodies from our solar system and beyond"
                    iconUrl: "/icons/planets.svg"
                    elementCount: 42
                    popularityScore: 75
                    previewElements: ["mercury", "venus", "mars", "jupiter", "saturn"]
                    createdAt: "2026-02-08T00:00:00.000Z"
                    relevanceScore: 0.80
                meta:
                  total: 2
                  page: 1
                  perPage: 20
                  totalPages: 1
                  query: "space"
        '400':
          description: Invalid search query
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: BAD_REQUEST
                message: "Search query 'q' is required and must be 1-200 characters"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /theme-library/{id}:
    get:
      operationId: getThemeLibraryItem
      summary: Get theme details with preview
      description: |
        Returns full details of a theme library item including grouped
        example elements (US-4 scenario 2, scenario 3).
        Shows theme description, example names grouped by element type,
        stats (element count, popularity), and a "Create Guide" CTA reference.

        Supports FR-008: Preview before committing.
        Supports FR-009: Display theme details including element count and samples.
      tags: [Theme Library]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Theme library item UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Full theme details with grouped elements
          content:
            application/json:
              schema:
                type: object
                required: [data]
                properties:
                  data:
                    $ref: '#/components/schemas/ThemeLibraryItemDetail'
              example:
                data:
                  id: "11111111-1111-1111-1111-111111111111"
                  name: "Harry Potter"
                  category: FICTION
                  description: "Characters, spells, and potions from the Wizarding World"
                  iconUrl: "/icons/harry-potter.svg"
                  elementCount: 52
                  popularityScore: 150
                  previewElements: ["dumbledore", "hermione", "hogwarts", "expelliarmus", "phoenix"]
                  createdAt: "2026-02-08T00:00:00.000Z"
                  elementsByType:
                    CHARACTER:
                      - elementText: "dumbledore"
                        displayOrder: 0
                      - elementText: "hermione"
                        displayOrder: 1
                      - elementText: "harry"
                        displayOrder: 2
                      - elementText: "voldemort"
                        displayOrder: 3
                      - elementText: "snape"
                        displayOrder: 4
                    PLACE:
                      - elementText: "hogwarts"
                        displayOrder: 20
                      - elementText: "diagon_alley"
                        displayOrder: 21
                      - elementText: "azkaban"
                        displayOrder: 22
                    OBJECT:
                      - elementText: "elder_wand"
                        displayOrder: 40
                      - elementText: "sorting_hat"
                        displayOrder: 41
                      - elementText: "polyjuice"
                        displayOrder: 42
                    CONCEPT:
                      - elementText: "expelliarmus"
                        displayOrder: 45
                      - elementText: "patronus"
                        displayOrder: 46
                  stats:
                    totalElements: 52
                    guidesCreated: 15
                    popularityRank: 1
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Azure Entra ID JWT token

  parameters:
    PageParam:
      name: page
      in: query
      description: Page number (1-based)
      schema:
        type: integer
        minimum: 1
        default: 1
    PerPageParam:
      name: perPage
      in: query
      description: Results per page
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    ThemeCategory:
      type: string
      enum: [FICTION, NATURE, CULTURE, CUSTOM]

    ElementType:
      type: string
      enum: [CHARACTER, PLACE, OBJECT, CONCEPT, OTHER]

    ThemeLibraryItem:
      type: object
      required: [id, name, category, elementCount, popularityScore, previewElements, createdAt]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          maxLength: 100
        category:
          $ref: '#/components/schemas/ThemeCategory'
        description:
          type: string
          maxLength: 500
          nullable: true
        iconUrl:
          type: string
          maxLength: 255
          nullable: true
        elementCount:
          type: integer
          minimum: 0
        popularityScore:
          type: integer
          minimum: 0
        previewElements:
          type: array
          description: 3-5 sample element names for preview cards
          items:
            type: string
          minItems: 3
          maxItems: 5
        createdAt:
          type: string
          format: date-time

    ThemeLibraryItemDetail:
      allOf:
        - $ref: '#/components/schemas/ThemeLibraryItem'
        - type: object
          required: [elementsByType, stats]
          properties:
            elementsByType:
              type: object
              description: |
                Elements grouped by ElementType (US-4 scenario 3).
                Keys are ElementType enum values.
              additionalProperties:
                type: array
                items:
                  type: object
                  required: [elementText, displayOrder]
                  properties:
                    elementText:
                      type: string
                    elementType:
                      $ref: '#/components/schemas/ElementType'
                    displayOrder:
                      type: integer
                      minimum: 0
            stats:
              type: object
              required: [totalElements, guidesCreated, popularityRank]
              properties:
                totalElements:
                  type: integer
                  description: Total number of elements in the theme
                guidesCreated:
                  type: integer
                  description: Number of guides created from this theme
                popularityRank:
                  type: integer
                  description: Rank among all themes by popularity

    PaginationMeta:
      type: object
      required: [total, page, perPage, totalPages]
      properties:
        total:
          type: integer
          minimum: 0
        page:
          type: integer
          minimum: 1
        perPage:
          type: integer
          minimum: 1
        totalPages:
          type: integer
          minimum: 0

    ErrorResponse:
      type: object
      required: [error, message]
      properties:
        error:
          type: string
        message:
          type: string
        details:
          description: Additional error context
          oneOf:
            - type: object
            - type: array
              items:
                type: object

  responses:
    Unauthorized:
      description: Missing or invalid JWT token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: UNAUTHORIZED
            message: "Authentication required. Provide a valid Azure Entra ID JWT token."
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: NOT_FOUND
            message: "Theme library item not found"
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: INTERNAL_ERROR
            message: "An unexpected error occurred"
