# Implementation Plan: System Architecture

**Branch**: `architecture` | **Date**: 2026-02-08 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/architecture/spec.md` and `/specs/architecture/README.md`

## Summary

Establish the core system architecture for SchemaJeli: Azure Entra ID authentication (MSAL + JWT/JWKS), RBAC (Admin/Maintainer/Viewer), full CRUD API over the Server → Database → Table → Element hierarchy with soft deletes, Prisma ORM, standard response envelopes, pagination, audit logging, Terraform-managed Azure infrastructure, and Docker Compose local development.

## Technical Context

**Language/Version**: TypeScript 5.x with Node.js 18+ LTS  
**Primary Dependencies**: Express.js 4.x, Prisma ORM 5.x, @azure/msal-node, @azure/msal-browser, React 19, Vite, Zustand, Tailwind CSS v4  
**Storage**: PostgreSQL 15+ via Prisma with soft deletes and audit logging  
**Testing**: Vitest (unit/integration), React Testing Library, Playwright (E2E)  
**Target Platform**: Azure App Service (backend), Azure Static Web App (frontend)  
**Project Type**: Web application (backend + frontend monorepo)  
**Performance Goals**: Simple queries <100ms, complex searches <500ms p95, 100+ concurrent users  
**Constraints**: HTTPS/TLS mandatory, soft deletes only, Entra ID-only auth  
**Scale/Scope**: ~500 servers, ~2K databases, ~50K tables, ~1M elements

## Constitution Check

### Security ✅
- ✅ Azure Entra ID authentication (MSAL) — no local passwords
- ✅ JWT validation via JWKS on every request
- ✅ RBAC: Admin, Maintainer, Viewer roles from token claims
- ✅ Prisma ORM with parameterized queries (SQL injection prevention)
- ✅ Audit trail via AuditLog table

### Data Integrity ✅
- ✅ Foreign keys: Server → Database → Table → Element with `onDelete: Restrict`
- ✅ Soft deletes via `deletedAt` field on all entities
- ✅ Optimistic locking via `updatedAt` timestamp

### Testing ✅
- ✅ Vitest for backend and frontend unit tests
- ✅ Playwright for E2E tests
- ✅ 70% minimum coverage target

### Observability ✅
- ✅ Winston structured logging
- ✅ Application Insights integration
- ✅ AuditLog for all data modifications

## Project Structure

### Documentation (this feature)

```text
specs/architecture/
├── README.md            # Architecture overview (existing)
├── spec.md              # User stories and requirements
├── plan.md              # This file
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── backend/
│   ├── prisma/
│   │   ├── schema.prisma        # 10 models, enums, indexes
│   │   ├── migrations/          # Prisma migrations
│   │   └── seed.ts              # Database seeding
│   ├── src/
│   │   ├── index.ts             # Express app + all route definitions
│   │   ├── config/              # Environment, logger config
│   │   ├── db/                  # Prisma client singleton
│   │   ├── middleware/          # auth.ts, rbac.ts
│   │   └── services/            # Business logic per entity
│   └── package.json
│
└── frontend/
    ├── src/
    │   ├── components/          # Reusable UI components
    │   ├── pages/               # Route-level pages
    │   ├── hooks/               # Custom React hooks
    │   ├── services/            # Axios API clients
    │   ├── store/               # Zustand stores
    │   ├── config/              # Auth config (MSAL)
    │   └── types/               # TypeScript interfaces
    └── package.json

infrastructure/
└── terraform/
    ├── modules/                 # App Service, DB, Key Vault, etc.
    └── environments/            # dev, staging, prod tfvars
```

**Structure Decision**: Web application (backend + frontend) with Terraform IaC. Both apps have independent package.json files. Root package.json only has Playwright for E2E tests.

## Implementation Status

The architecture is approximately **85% implemented**. Key gaps identified:

| Area | Status | Gap |
|------|--------|-----|
| Auth (JWT/JWKS) | ✅ Implemented | — |
| RBAC middleware | ✅ Implemented | — |
| Prisma schema (10 models) | ✅ Implemented | Minor: entraId migration, EDITOR→MAINTAINER |
| CRUD routes (all entities) | ✅ Implemented | All in index.ts, not split into route files |
| Soft deletes | ✅ Implemented | — |
| Audit logging | ⚠️ Partial | AuditLog model exists, integration in routes incomplete |
| Error handling middleware | ❌ Missing | No global error handler |
| Rate limiting | ❌ Missing | Not implemented |
| Pagination standardization | ⚠️ Partial | Some routes, not all |
| Terraform modules | ✅ Implemented | All modules defined |
| Docker Compose | ✅ Implemented | 3 services working |
| Application Insights | ⚠️ Partial | Terraform defined, backend integration incomplete |
| Winston logging | ✅ Implemented | — |
| Frontend MSAL | ⚠️ Partial | Config exists, full flow needs completion |

## Complexity Tracking

> No complexity violations — architecture follows constitution principles.
