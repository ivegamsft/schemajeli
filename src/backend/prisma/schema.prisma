// SchemaJeli Database Schema
// PostgreSQL database schema for metadata repository system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

enum EntityStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum RdbmsType {
  POSTGRESQL
  MYSQL
  ORACLE
  DB2
  INFORMIX
  SQLSERVER
}

enum TableType {
  TABLE
  VIEW
  MATERIALIZED_VIEW
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
}

enum EntityType {
  SERVER
  DATABASE
  TABLE
  ELEMENT
  ABBREVIATION
  USER
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id            String    @id @default(uuid()) @db.Uuid
  username      String    @unique @db.VarChar(100)
  email         String    @unique @db.VarChar(255)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  fullName      String    @map("full_name") @db.VarChar(255)
  role          UserRole  @default(VIEWER)
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamptz
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relationships - created entities
  serversCreated       Server[]       @relation("ServerCreatedBy")
  databasesCreated     Database[]     @relation("DatabaseCreatedBy")
  tablesCreated        Table[]        @relation("TableCreatedBy")
  elementsCreated      Element[]      @relation("ElementCreatedBy")
  abbreviationsCreated Abbreviation[] @relation("AbbreviationCreatedBy")
  auditLogs            AuditLog[]     @relation("AuditLogUser")

  @@map("users")
  @@index([username])
  @@index([email])
}

// ============================================================================
// CORE ENTITIES - Database Metadata Hierarchy
// ============================================================================

model Server {
  id          String       @id @default(uuid()) @db.Uuid
  name        String       @unique @db.VarChar(255)
  description String?      @db.Text
  host        String       @db.VarChar(255)
  port        Int?
  rdbmsType   RdbmsType    @map("rdbms_type")
  location    String?      @db.VarChar(255)
  status      EntityStatus @default(ACTIVE)
  createdById String       @map("created_by_id") @db.Uuid
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime     @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime?    @map("deleted_at") @db.Timestamptz

  // Relationships
  createdBy User       @relation("ServerCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  databases Database[]

  @@map("servers")
  @@index([name])
  @@index([status])
  @@index([deletedAt])
}

model Database {
  id          String       @id @default(uuid()) @db.Uuid
  serverId    String       @map("server_id") @db.Uuid
  name        String       @db.VarChar(255)
  description String?      @db.Text
  purpose     String?      @db.VarChar(500)
  status      EntityStatus @default(ACTIVE)
  createdById String       @map("created_by_id") @db.Uuid
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime     @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt   DateTime?    @map("deleted_at") @db.Timestamptz

  // Relationships
  server    Server  @relation(fields: [serverId], references: [id], onDelete: Restrict)
  createdBy User    @relation("DatabaseCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  tables    Table[]

  @@unique([serverId, name])
  @@map("databases")
  @@index([serverId])
  @@index([name])
  @@index([status])
  @@index([deletedAt])
}

model Table {
  id               String       @id @default(uuid()) @db.Uuid
  databaseId       String       @map("database_id") @db.Uuid
  name             String       @db.VarChar(255)
  description      String?      @db.Text
  tableType        TableType    @default(TABLE) @map("table_type")
  rowCountEstimate Int?         @map("row_count_estimate")
  status           EntityStatus @default(ACTIVE)
  createdById      String       @map("created_by_id") @db.Uuid
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime     @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt        DateTime?    @map("deleted_at") @db.Timestamptz

  // Relationships
  database  Database  @relation(fields: [databaseId], references: [id], onDelete: Restrict)
  createdBy User      @relation("TableCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  elements  Element[]

  @@unique([databaseId, name])
  @@map("tables")
  @@index([databaseId])
  @@index([name])
  @@index([status])
  @@index([tableType])
  @@index([deletedAt])
}

model Element {
  id           String    @id @default(uuid()) @db.Uuid
  tableId      String    @map("table_id") @db.Uuid
  name         String    @db.VarChar(255)
  description  String?   @db.Text
  dataType     String    @map("data_type") @db.VarChar(100)
  length       Int?
  precision    Int?
  scale        Int?
  isNullable   Boolean   @default(true) @map("is_nullable")
  isPrimaryKey Boolean   @default(false) @map("is_primary_key")
  isForeignKey Boolean   @default(false) @map("is_foreign_key")
  defaultValue String?   @map("default_value") @db.VarChar(500)
  position     Int // Column order in table
  createdById  String    @map("created_by_id") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz

  // Relationships
  table     Table @relation(fields: [tableId], references: [id], onDelete: Restrict)
  createdBy User  @relation("ElementCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  @@unique([tableId, name])
  @@map("elements")
  @@index([tableId])
  @@index([name])
  @@index([isPrimaryKey])
  @@index([isForeignKey])
  @@index([deletedAt])
}

// ============================================================================
// REFERENCE DATA
// ============================================================================

model Abbreviation {
  id           String    @id @default(uuid()) @db.Uuid
  source       String    @db.VarChar(500)
  abbreviation String    @unique @db.VarChar(100)
  definition   String?   @db.Text
  isPrimeClass Boolean   @default(false) @map("is_prime_class")
  category     String?   @db.VarChar(100)
  createdById  String    @map("created_by_id") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relationships
  createdBy User @relation("AbbreviationCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  @@map("abbreviations")
  @@index([source])
  @@index([category])
}

// ============================================================================
// AUDIT & TRACKING
// ============================================================================

model AuditLog {
  id         String      @id @default(uuid()) @db.Uuid
  entityType EntityType  @map("entity_type")
  entityId   String      @map("entity_id") @db.Uuid
  action     AuditAction
  userId     String      @map("user_id") @db.Uuid
  changes    Json? // Old and new values as JSON
  ipAddress  String?     @map("ip_address") @db.VarChar(45)
  userAgent  String?     @map("user_agent") @db.VarChar(500)
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz

  // Relationships
  user User @relation("AuditLogUser", fields: [userId], references: [id], onDelete: Restrict)

  @@map("audit_logs")
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

// ============================================================================
// SEARCH & OPTIMIZATION
// ============================================================================

model SearchIndex {
  id         String     @id @default(uuid()) @db.Uuid
  entityType EntityType @map("entity_type")
  entityId   String     @map("entity_id") @db.Uuid
  content    String     @db.Text // Searchable concatenated content
  metadata   Json? // Additional search metadata
  createdAt  DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  @@map("search_index")
  @@index([entityType, entityId])
  @@index([content(ops: raw("gin_trgm_ops"))], type: Gin) // Full-text search
}
